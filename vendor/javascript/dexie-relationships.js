// dexie-relationships@1.2.11 downloaded from https://ga.jspm.io/npm:dexie-relationships@1.2.11/dist/index.js

import e from"dexie";var r="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var t={};(function(r,n){t=n(e)})(t,(function(e){e="default"in e?e["default"]:e;var t=function SchemaParser(e){(this||r).schema=e};t.prototype.getForeignKeys=function getForeignKeys(){var e=this||r;var t={};Object.keys((this||r).schema).forEach((function(r){var n=e.schema[r].split(",");t[r]=n.filter((function(e){return-1!==e.indexOf("->")})).map((function(e){var r=e.split("->").map((function(e){return e.trim()}));var t=r[0];var n=r[1];return{index:t,targetTable:n.split(".")[0],targetIndex:n.split(".")[1]}}))}));return t};t.prototype.getCleanedSchema=function getCleanedSchema(){var e=this||r;var t={};Object.keys((this||r).schema).forEach((function(r){var n=e.schema[r].split(",");t[r]=n.map((function(e){return e.split("->")[0].trim()})).join(",")}));return t};function isIndexableType(e){return null!=e&&("string"===typeof e||"number"===typeof e||e instanceof Date||Array.isArray(e)&&e.every(isIndexableType))}var Relationships=function(n){var a=e.Promise;n.Table.prototype.with=function(e){return this.toCollection().with(e)};n.Collection.prototype.with=function(e){var t=this||r;var o=(this||r)._ctx.table.name;var i=n._allTables;var f=[];Object.keys(e).forEach((function(r){var n=e[r];var a=t._ctx.table.schema.idxByName[n];if(a&&a.hasOwnProperty("foreignKey")){var s=a;f.push({column:r,index:s.foreignKey.targetIndex,tableName:s.foreignKey.targetTable,targetIndex:s.foreignKey.index,oneToOne:true})}else{var u=n;if(!i.hasOwnProperty(u))throw new Error("Relationship table "+u+" doesn't exist.");if(!i[u].schema.hasOwnProperty("foreignKeys"))throw new Error("Relationship table "+u+" doesn't have foreign keys set.");var l=i[u].schema.foreignKeys.filter((function(e){return e.targetTable===o}));l.length>0&&f.push({column:r,index:l[0].index,tableName:u,targetIndex:l[0].targetIndex})}}));return this.toArray().then((function(e){var r=f.map((function(r){var t=r.tableName;var n=e.map((function(e){return e[r.targetIndex]})).filter(isIndexableType);return i[t].where(r.index).anyOf(n)}));var t=r.map((function(e){return e.toArray()}));return a.all(t).then((function(r){f.forEach((function(t,n){var a=t.tableName;var i=r[n];var f=t.targetIndex;var s=t.index;var u=t.column;var l={};i.forEach((function(e){var r=e[s];t.oneToOne?l[r]=e:(l[r]=l[r]||[]).push(e)}));e.forEach((function(e){var r=e[f];var t=l[r]||[];if(null!==r&&void 0!==r&&!t)throw new Error("Could not lookup foreign key where "+a+"."+s+" == "+o+"."+u+". "+"The content of the failing key was: "+JSON.stringify(r)+".");Object.defineProperty(e,u,{value:t,enumerable:false,configurable:true,writable:true})}))}))})).then((function(){return e}))}))};n.Version.prototype._parseStoresSpec=e.override(n.Version.prototype._parseStoresSpec,(function(e){return function(n,a){var o=new t(n);var i=o.getForeignKeys();var f=e.call(this||r,o.getCleanedSchema(),a);Object.keys(a).forEach((function(e){if(i.hasOwnProperty(e)){a[e].foreignKeys=i[e];i[e].forEach((function(r){a[e].idxByName[r.index].foreignKey=r}))}}));return f}}))};Relationships.default=Relationships;return Relationships}));var n=t;export default n;

